{{define "title"}}Tenants - KWS{{end}}
{{define "page-title"}}Tenants{{end}}

{{define "content"}}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <p class="text-gray-500 dark:text-gray-400">Manage your B2B customer organizations</p>
        </div>
        <button onclick="openCreateModal()"
                class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition-colors">
            <span class="material-symbols-outlined mr-2">add</span>
            Add Tenant
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white dark:bg-surface-dark rounded-xl shadow-sm border border-gray-200 dark:border-border-dark p-4">
        <div class="flex items-center space-x-4">
            <div class="flex-1">
                <input type="text" id="search-input" placeholder="Search tenants..."
                       class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-border-dark bg-gray-50 dark:bg-surface-highlight text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary focus:border-transparent"
                       hx-get="/tenants"
                       hx-trigger="keyup changed delay:300ms"
                       hx-target="#tenants-table"
                       hx-include="[name='status']">
            </div>
            <select name="status"
                    class="px-4 py-2 rounded-lg border border-gray-300 dark:border-border-dark bg-gray-50 dark:bg-surface-highlight text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-primary focus:border-transparent"
                    hx-get="/tenants"
                    hx-trigger="change"
                    hx-target="#tenants-table"
                    hx-include="#search-input">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="trial">Trial</option>
                <option value="suspended">Suspended</option>
            </select>
        </div>
    </div>

    <!-- Tenants Table -->
    <div id="tenants-table" class="bg-white dark:bg-surface-dark rounded-xl shadow-sm border border-gray-200 dark:border-border-dark overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-border-dark">
            <thead class="bg-gray-50 dark:bg-surface-highlight">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-text-secondary uppercase tracking-wider">Tenant</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-text-secondary uppercase tracking-wider">Plan</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-text-secondary uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-text-secondary uppercase tracking-wider">Sites</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-text-secondary uppercase tracking-wider">Created</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-text-secondary uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-surface-dark divide-y divide-gray-200 dark:divide-border-dark">
                {{range .Tenants}}
                <tr class="hover:bg-gray-50 dark:hover:bg-surface-highlight">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-lg bg-primary/10 dark:bg-primary/20 flex items-center justify-center">
                                <span class="material-symbols-outlined text-primary">business</span>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900 dark:text-white">{{.Name}}</div>
                                <div class="text-sm text-gray-500">{{.Code}}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full
                            {{if eq .Plan "enterprise"}}bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300
                            {{else if eq .Plan "professional"}}bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300
                            {{else}}bg-gray-100 text-gray-700 dark:bg-gray-600 dark:text-gray-300{{end}}">
                            {{.Plan}}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full
                            {{if eq .Status "active"}}bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300
                            {{else if eq .Status "trial"}}bg-yellow-100 text-yellow-700 dark:bg-yellow-900/50 dark:text-yellow-300
                            {{else}}bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300{{end}}">
                            {{.Status}}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{.SiteCount}} sites
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{.CreatedAt}}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex items-center justify-end space-x-2">
                            <a href="/tenants/{{.ID}}"
                               class="p-2 text-gray-500 hover:text-primary hover:bg-gray-100 dark:hover:bg-surface-highlight rounded-lg">
                                <span class="material-symbols-outlined text-lg">visibility</span>
                            </a>
                            <button onclick="openEditModal('{{.ID}}')"
                                    class="p-2 text-gray-500 hover:text-primary hover:bg-gray-100 dark:hover:bg-surface-highlight rounded-lg">
                                <span class="material-symbols-outlined text-lg">edit</span>
                            </button>
                            <button onclick="confirmDelete('{{.ID}}', '{{.Name}}')"
                                    class="p-2 text-gray-500 hover:text-red-600 hover:bg-gray-100 dark:hover:bg-surface-highlight rounded-lg">
                                <span class="material-symbols-outlined text-lg">delete</span>
                            </button>
                        </div>
                    </td>
                </tr>
                {{else}}
                <tr>
                    <td colspan="6" class="px-6 py-12 text-center">
                        <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">business</span>
                        <p class="text-gray-500 dark:text-text-secondary">No tenants found</p>
                        <button onclick="openCreateModal()"
                                class="mt-4 inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover">
                            <span class="material-symbols-outlined mr-2">add</span>
                            Create your first tenant
                        </button>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>

        <!-- Pagination (only shown when TotalPages > 1) -->
        {{with .TotalPages}}{{if gt . 1}}
        <div class="px-6 py-4 border-t border-gray-200 dark:border-border-dark flex items-center justify-between">
            <div class="text-sm text-gray-500 dark:text-text-secondary">
                Showing {{$.StartIndex}} to {{$.EndIndex}} of {{$.Total}} tenants
            </div>
            <div class="flex items-center space-x-2">
                {{if gt $.Page 1}}
                <a href="?page={{sub $.Page 1}}"
                   class="px-3 py-1 rounded border border-gray-300 dark:border-border-dark text-sm hover:bg-gray-50 dark:hover:bg-surface-highlight">
                    Previous
                </a>
                {{end}}
                {{range $.Pages}}
                <a href="?page={{.}}"
                   class="px-3 py-1 rounded text-sm {{if eq . $.Page}}bg-primary text-white{{else}}border border-gray-300 dark:border-border-dark hover:bg-gray-50 dark:hover:bg-surface-highlight{{end}}">
                    {{.}}
                </a>
                {{end}}
                {{if lt $.Page $.TotalPages}}
                <a href="?page={{add $.Page 1}}"
                   class="px-3 py-1 rounded border border-gray-300 dark:border-border-dark text-sm hover:bg-gray-50 dark:hover:bg-surface-highlight">
                    Next
                </a>
                {{end}}
            </div>
        </div>
        {{end}}{{end}}
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="tenant-modal" class="fixed inset-0 z-50 hidden" x-data="{ open: false }">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-black/50 modal-backdrop" onclick="closeModal()"></div>
        <div class="relative bg-white dark:bg-surface-dark rounded-xl shadow-xl w-full max-w-lg p-6 border border-gray-200 dark:border-border-dark">
            <div class="flex items-center justify-between mb-6">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-900 dark:text-white">Create Tenant</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form id="tenant-form" hx-post="/api/v1/tenants" hx-swap="none">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-text-secondary mb-1">Code</label>
                        <input type="text" name="code" required
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-border-dark bg-gray-50 dark:bg-surface-highlight text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"
                               placeholder="abc-foods">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-text-secondary mb-1">Name</label>
                        <input type="text" name="name" required
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-border-dark bg-gray-50 dark:bg-surface-highlight text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"
                               placeholder="ABC Foods Inc.">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-text-secondary mb-1">Plan</label>
                        <select name="plan" required
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-border-dark bg-gray-50 dark:bg-surface-highlight text-gray-900 dark:text-white focus:ring-2 focus:ring-primary">
                            <option value="starter">Starter</option>
                            <option value="professional">Professional</option>
                            <option value="enterprise">Enterprise</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-text-secondary mb-1">Contact Email</label>
                        <input type="email" name="contact_email" required
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-border-dark bg-gray-50 dark:bg-surface-highlight text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"
                               placeholder="admin@abcfoods.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-text-secondary mb-1">Contact Phone</label>
                        <input type="tel" name="contact_phone"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-border-dark bg-gray-50 dark:bg-surface-highlight text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"
                               placeholder="+1 555-123-4567">
                    </div>
                </div>
                <div class="flex items-center justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeModal()"
                            class="px-4 py-2 text-gray-700 dark:text-text-secondary hover:bg-gray-100 dark:hover:bg-surface-highlight rounded-lg">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover">
                        Save Tenant
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{{end}}

{{define "scripts"}}
<script>
function openCreateModal() {
    document.getElementById('modal-title').textContent = 'Create Tenant';
    const form = document.getElementById('tenant-form');
    form.setAttribute('hx-post', '/api/v1/tenants');
    form.removeAttribute('hx-put');
    form.reset();
    document.getElementById('tenant-modal').classList.remove('hidden');
    htmx.process(form);
}

function openEditModal(id) {
    document.getElementById('modal-title').textContent = 'Edit Tenant';
    const form = document.getElementById('tenant-form');
    form.removeAttribute('hx-post');
    form.setAttribute('hx-put', '/api/v1/tenants/' + id);
    document.getElementById('tenant-modal').classList.remove('hidden');
    // TODO: Fetch and populate tenant data
    htmx.process(form);
}

function closeModal() {
    document.getElementById('tenant-modal').classList.add('hidden');
}

function confirmDelete(id, name) {
    if (confirm('Are you sure you want to delete tenant "' + name + '"?')) {
        htmx.ajax('DELETE', '/api/v1/tenants/' + id, {
            target: '#tenants-table',
            swap: 'innerHTML'
        });
    }
}

// Handle successful form submission
document.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.elt.id === 'tenant-form' && event.detail.successful) {
        closeModal();
        window.location.reload();
    }
});

// Handle form errors
document.addEventListener('htmx:responseError', function(event) {
    if (event.detail.elt.id === 'tenant-form') {
        const response = JSON.parse(event.detail.xhr.responseText);
        alert('Error: ' + (response.error?.message || 'Failed to save tenant'));
    }
});
</script>
{{end}}
