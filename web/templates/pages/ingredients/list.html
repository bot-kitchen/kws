{{define "title"}}Ingredients - KWS{{end}}
{{define "page-title"}}Ingredients{{end}}

{{define "ingredients-list"}}
<div class="flex flex-col gap-6">
    <!-- Page Header -->
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-3xl md:text-4xl font-bold tracking-tight mb-2">Ingredients</h1>
            <p class="text-gray-500 dark:text-text-secondary text-sm md:text-base">
                Manage ingredient inventory and specifications
            </p>
        </div>
        <a href="/ingredients/new"
           class="flex items-center justify-center gap-2 rounded-lg bg-primary hover:bg-primary/90 text-white px-6 py-3 text-sm font-bold transition-all shadow-[0_0_15px_rgba(110,86,207,0.3)]">
            <span class="material-symbols-outlined text-xl">add</span>
            <span>Add Ingredient</span>
        </a>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4">
        <div class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-dark rounded-xl p-4">
            <div class="flex items-center gap-2 text-gray-500 dark:text-text-secondary mb-1">
                <span class="material-symbols-outlined text-lg">inventory_2</span>
                <span class="text-sm font-medium">Total</span>
            </div>
            <p class="text-3xl font-bold text-gray-900 dark:text-white">{{len .Ingredients}}</p>
        </div>
        <div class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-dark rounded-xl p-4">
            <div class="flex items-center gap-2 text-green-600 dark:text-green-400 mb-1">
                <span class="material-symbols-outlined text-lg">check_circle</span>
                <span class="text-sm font-medium">Active</span>
            </div>
            <p class="text-3xl font-bold text-gray-900 dark:text-white">{{.ActiveCount}}</p>
        </div>
        <div class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-dark rounded-xl p-4">
            <div class="flex items-center gap-2 text-red-600 dark:text-red-400 mb-1">
                <span class="material-symbols-outlined text-lg">block</span>
                <span class="text-sm font-medium">Inactive</span>
            </div>
            <p class="text-3xl font-bold text-gray-900 dark:text-white">{{.InactiveCount}}</p>
        </div>
        <div class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-dark rounded-xl p-4">
            <div class="flex items-center gap-2 text-yellow-600 dark:text-yellow-400 mb-1">
                <span class="material-symbols-outlined text-lg">package_2</span>
                <span class="text-sm font-medium">Dry</span>
            </div>
            <p class="text-3xl font-bold text-gray-900 dark:text-white">{{.DryCount}}</p>
        </div>
        <div class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-dark rounded-xl p-4">
            <div class="flex items-center gap-2 text-green-600 dark:text-green-400 mb-1">
                <span class="material-symbols-outlined text-lg">grain</span>
                <span class="text-sm font-medium">Wet</span>
            </div>
            <p class="text-3xl font-bold text-gray-900 dark:text-white">{{.WetCount}}</p>
        </div>
        <div class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-dark rounded-xl p-4">
            <div class="flex items-center gap-2 text-blue-600 dark:text-blue-400 mb-1">
                <span class="material-symbols-outlined text-lg">water_drop</span>
                <span class="text-sm font-medium">Liquid</span>
            </div>
            <p class="text-3xl font-bold text-gray-900 dark:text-white">{{.LiquidCount}}</p>
        </div>
    </div>

    <!-- Search and Filter Bar -->
    <div class="flex flex-wrap gap-3 items-center">
        <!-- Horizontal Type Selector -->
        <div class="flex rounded-lg border border-gray-300 dark:border-border-dark overflow-hidden">
            <button type="button" data-filter="" class="filter-btn px-3 py-1.5 text-sm font-medium bg-primary text-white transition-colors">
                All
            </button>
            <button type="button" data-filter="dry" class="filter-btn px-3 py-1.5 text-sm font-medium bg-white dark:bg-surface-dark text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-surface-highlight transition-colors border-l border-gray-300 dark:border-border-dark">
                Dry
            </button>
            <button type="button" data-filter="wet" class="filter-btn px-3 py-1.5 text-sm font-medium bg-white dark:bg-surface-dark text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-surface-highlight transition-colors border-l border-gray-300 dark:border-border-dark">
                Wet
            </button>
            <button type="button" data-filter="liquid" class="filter-btn px-3 py-1.5 text-sm font-medium bg-white dark:bg-surface-dark text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-surface-highlight transition-colors border-l border-gray-300 dark:border-border-dark">
                Liquid
            </button>
        </div>
        <div class="relative ml-auto">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-lg">search</span>
            <input type="text" id="search-ingredients" placeholder="Search ingredients..." class="pl-10 pr-4 py-2 text-sm bg-white dark:bg-surface-dark border border-gray-300 dark:border-border-dark rounded-lg text-gray-900 dark:text-white w-64">
        </div>
    </div>

    <!-- Ingredients Cards Grid -->
    {{if .Ingredients}}
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3">
        {{range .Ingredients}}
        <div class="ingredient-card group relative bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-dark rounded-xl p-3 hover:border-primary/50 transition-all duration-200 {{if not .IsActive}}opacity-60{{end}}"
             data-name="{{.Name}}" data-moisture="{{.MoistureType}}" data-active="{{.IsActive}}" data-id="{{.ID}}">
            <!-- Card Header -->
            <div class="flex items-center gap-2 mb-2">
                <span class="material-symbols-outlined text-lg
                    {{if eq .MoistureType "dry"}}text-yellow-600 dark:text-yellow-400
                    {{else if eq .MoistureType "wet"}}text-green-600 dark:text-green-400
                    {{else if eq .MoistureType "liquid"}}text-blue-600 dark:text-blue-400
                    {{else}}text-primary{{end}}">
                    {{if eq .MoistureType "dry"}}package_2{{else if eq .MoistureType "wet"}}grain{{else if eq .MoistureType "liquid"}}water_drop{{else}}inventory_2{{end}}
                </span>
                <span class="text-[10px] px-1.5 py-0.5 rounded
                    {{if eq .MoistureType "dry"}}bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400
                    {{else if eq .MoistureType "wet"}}bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400
                    {{else if eq .MoistureType "liquid"}}bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400
                    {{else}}bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300{{end}}">
                    {{.MoistureType}}
                </span>
                {{if not .IsActive}}
                <span class="text-[10px] px-1.5 py-0.5 rounded bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 ml-auto">
                    Inactive
                </span>
                {{end}}
            </div>

            <!-- Name (truncated) -->
            <h3 class="text-sm font-bold text-gray-900 dark:text-white truncate mb-1 {{if not .IsActive}}line-through{{end}}" title="{{.Name}}">{{.Name}}</h3>

            <!-- Quick Info -->
            <div class="text-[10px] text-gray-500 dark:text-text-secondary space-y-0.5 mb-2">
                <div class="flex justify-between">
                    <span>Shelf Life</span>
                    <span class="text-gray-900 dark:text-white">{{if .ShelfLifeMinutes}}{{divFloat .ShelfLifeMinutes 60 | printf "%.0f"}}h{{else}}-{{end}}</span>
                </div>
                <div class="flex justify-between">
                    <span>Calories</span>
                    <span class="text-gray-900 dark:text-white">{{if .CaloriesPer100g}}{{printf "%.0f" .CaloriesPer100g}}{{else}}-{{end}}</span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-1 pt-2 border-t border-gray-100 dark:border-border-dark">
                <button onclick="toggleIngredient('{{.ID}}', {{.IsActive}})" class="flex-1 p-1.5 rounded-lg transition-colors flex items-center justify-center {{if .IsActive}}text-green-600 dark:text-green-400 hover:bg-red-100 dark:hover:bg-red-900/30 hover:text-red-600 dark:hover:text-red-400{{else}}text-red-600 dark:text-red-400 hover:bg-green-100 dark:hover:bg-green-900/30 hover:text-green-600 dark:hover:text-green-400{{end}}" title="{{if .IsActive}}Deactivate{{else}}Activate{{end}}">
                    <span class="material-symbols-outlined text-sm">{{if .IsActive}}check_circle{{else}}block{{end}}</span>
                </button>
                <a href="/ingredients/{{.ID}}/edit" class="flex-1 p-1.5 rounded-lg text-gray-400 dark:text-gray-500 hover:bg-gray-100 dark:hover:bg-surface-highlight hover:text-gray-700 dark:hover:text-white transition-colors flex items-center justify-center" title="Edit">
                    <span class="material-symbols-outlined text-sm">edit</span>
                </a>
                <button onclick="deleteIngredient('{{.ID}}', '{{.Name}}')" class="flex-1 p-1.5 rounded-lg text-gray-400 dark:text-gray-500 hover:bg-red-100 dark:hover:bg-red-900/30 hover:text-red-600 dark:hover:text-red-400 transition-colors flex items-center justify-center" title="Delete">
                    <span class="material-symbols-outlined text-sm">delete</span>
                </button>
            </div>

            <!-- Hover Tooltip with Full Details -->
            <div class="absolute left-full top-0 ml-2 z-50 hidden group-hover:block w-64 bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-dark rounded-xl shadow-lg p-4 pointer-events-none">
                <h4 class="text-sm font-bold text-gray-900 dark:text-white mb-2 break-words">{{.Name}}</h4>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-text-secondary">Type</span>
                        <span class="font-medium text-gray-900 dark:text-white capitalize">{{.MoistureType}}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-text-secondary">Shelf Life</span>
                        <span class="font-medium text-gray-900 dark:text-white">{{if .ShelfLifeMinutes}}{{divFloat .ShelfLifeMinutes 60 | printf "%.1f"}} hours{{else}}N/A{{end}}</span>
                    </div>
                    <div class="border-t border-gray-100 dark:border-border-dark pt-2 mt-2">
                        <p class="text-gray-500 dark:text-text-secondary mb-1 font-medium">Nutrition per 100g</p>
                        <div class="grid grid-cols-2 gap-1">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Calories</span>
                                <span class="text-gray-900 dark:text-white">{{printf "%.0f" .CaloriesPer100g}}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Protein</span>
                                <span class="text-gray-900 dark:text-white">{{printf "%.1f" .ProteinPer100g}}g</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Carbs</span>
                                <span class="text-gray-900 dark:text-white">{{printf "%.1f" .CarbsPer100g}}g</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Fat</span>
                                <span class="text-gray-900 dark:text-white">{{printf "%.1f" .FatPer100g}}g</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Fiber</span>
                                <span class="text-gray-900 dark:text-white">{{printf "%.1f" .FiberPer100g}}g</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Sugar</span>
                                <span class="text-gray-900 dark:text-white">{{printf "%.1f" .SugarPer100g}}g</span>
                            </div>
                        </div>
                    </div>
                    {{if .AllergenInfo}}
                    <div class="border-t border-gray-100 dark:border-border-dark pt-2 mt-2">
                        <p class="text-gray-500 dark:text-text-secondary mb-1 font-medium">Allergens</p>
                        <p class="text-gray-900 dark:text-white">{{.AllergenInfo}}</p>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>
        {{end}}
    </div>
    {{else}}
    <div class="flex flex-col items-center justify-center py-16 bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-dark rounded-xl">
        <div class="bg-gray-100 dark:bg-surface-highlight p-4 rounded-full mb-4">
            <span class="material-symbols-outlined text-4xl text-gray-400 dark:text-text-secondary">inventory_2</span>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No ingredients found</h3>
        <p class="text-gray-500 dark:text-text-secondary mb-6">Get started by adding your first ingredient</p>
        <a href="/ingredients/new"
           class="flex items-center gap-2 rounded-lg bg-primary hover:bg-primary/90 text-white px-6 py-3 text-sm font-bold transition-all">
            <span class="material-symbols-outlined">add</span>
            <span>Add Your First Ingredient</span>
        </a>
    </div>
    {{end}}
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-dark rounded-xl p-5 max-w-sm w-full shadow-2xl">
        <div class="flex items-center gap-3 mb-4">
            <div class="p-2 bg-red-100 dark:bg-red-900/30 rounded-lg">
                <span class="material-symbols-outlined text-red-600 dark:text-red-400">delete</span>
            </div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">Delete Ingredient</h2>
        </div>
        <p class="text-gray-600 dark:text-text-secondary text-sm mb-4">
            Are you sure you want to delete <span id="deleteItemName" class="font-semibold text-gray-900 dark:text-white"></span>? This action cannot be undone.
        </p>
        <input type="hidden" id="deleteItemId">
        <div class="flex gap-2">
            <button type="button" onclick="closeDeleteModal()" class="flex-1 py-2 px-3 rounded-lg bg-gray-100 dark:bg-surface-highlight hover:bg-gray-200 dark:hover:bg-border-dark text-gray-700 dark:text-white text-sm font-medium transition-colors">Cancel</button>
            <button type="button" onclick="confirmDelete()" id="deleteConfirmBtn" class="flex-1 py-2 px-3 rounded-lg bg-red-600 hover:bg-red-700 text-white text-sm font-bold transition-colors">Delete</button>
        </div>
        <div id="deleteMessage" class="mt-3 hidden text-sm text-red-600 dark:text-red-400"></div>
    </div>
</div>

<script>
let currentMoistureFilter = '';

// Filter functionality for ingredients
function filterIngredients() {
    const searchTerm = document.getElementById('search-ingredients').value.toLowerCase();

    document.querySelectorAll('.ingredient-card').forEach(card => {
        const name = (card.dataset.name || '').toLowerCase();
        const moisture = (card.dataset.moisture || '').toLowerCase();

        const matchesMoisture = !currentMoistureFilter || moisture === currentMoistureFilter;
        const matchesSearch = !searchTerm || name.includes(searchTerm);

        card.style.display = matchesMoisture && matchesSearch ? '' : 'none';
    });
}

// Handle filter button clicks
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        currentMoistureFilter = btn.dataset.filter;

        // Update button styles
        document.querySelectorAll('.filter-btn').forEach(b => {
            if (b === btn) {
                b.classList.remove('bg-white', 'dark:bg-surface-dark', 'text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-surface-highlight');
                b.classList.add('bg-primary', 'text-white');
            } else {
                b.classList.remove('bg-primary', 'text-white');
                b.classList.add('bg-white', 'dark:bg-surface-dark', 'text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-surface-highlight');
            }
        });

        filterIngredients();
    });
});

// Delete ingredient - show modal
function deleteIngredient(id, name) {
    document.getElementById('deleteItemId').value = id;
    document.getElementById('deleteItemName').textContent = name;
    document.getElementById('deleteMessage').classList.add('hidden');
    document.getElementById('deleteConfirmBtn').disabled = false;
    document.getElementById('deleteModal').classList.remove('hidden');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
}

async function confirmDelete() {
    const id = document.getElementById('deleteItemId').value;
    const btn = document.getElementById('deleteConfirmBtn');
    const msg = document.getElementById('deleteMessage');

    btn.disabled = true;
    btn.textContent = 'Deleting...';

    try {
        const response = await fetch(`/api/v1/ingredients/${id}`, { method: 'DELETE' });
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to delete ingredient');
        }
        window.location.reload();
    } catch (error) {
        console.error('Error:', error);
        msg.textContent = error.message;
        msg.classList.remove('hidden');
        btn.disabled = false;
        btn.textContent = 'Delete';
    }
}

// Toggle ingredient active status
async function toggleIngredient(id, currentlyActive) {
    try {
        const response = await fetch(`/api/v1/ingredients/${id}/toggle-active`, { method: 'POST' });
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error?.message || data.error || 'Failed to toggle ingredient');
        }
        window.location.reload();
    } catch (error) {
        console.error('Error toggling ingredient:', error);
        alert('Failed to toggle ingredient: ' + error.message);
    }
}

// Close modal on backdrop click
document.getElementById('deleteModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeDeleteModal();
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !document.getElementById('deleteModal').classList.contains('hidden')) {
        closeDeleteModal();
    }
});

document.getElementById('search-ingredients')?.addEventListener('input', filterIngredients);
</script>
{{end}}
