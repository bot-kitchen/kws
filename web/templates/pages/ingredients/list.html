{{define "title"}}Ingredients - KWS{{end}}
{{define "page-title"}}Ingredients{{end}}

{{define "ingredients-list"}}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <p class="text-gray-500 dark:text-gray-400">Manage ingredient inventory and specifications</p>
        </div>
        <button onclick="openCreateModal()"
                class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition-colors shadow-lg shadow-primary-600/20">
            <span class="material-symbols-outlined mr-2">add</span>
            Add Ingredient
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white dark:bg-surface-dark rounded-xl shadow-sm border border-gray-200 dark:border-border-dark p-4">
        <div class="flex flex-wrap gap-3 items-center">
            <!-- Type Filter -->
            <div class="flex rounded-lg border border-gray-300 dark:border-border-dark overflow-hidden">
                <button type="button" data-filter="" class="filter-btn filter-active px-3 py-1.5 text-sm font-medium bg-primary text-white transition-colors">
                    All ({{len .Ingredients}})
                </button>
                <button type="button" data-filter="dry" class="filter-btn px-3 py-1.5 text-sm font-medium bg-white dark:bg-surface-highlight text-gray-600 dark:text-gray-300 transition-colors border-l border-gray-300 dark:border-border-dark">
                    Dry ({{.DryCount}})
                </button>
                <button type="button" data-filter="wet" class="filter-btn px-3 py-1.5 text-sm font-medium bg-white dark:bg-surface-highlight text-gray-600 dark:text-gray-300 transition-colors border-l border-gray-300 dark:border-border-dark">
                    Wet ({{.WetCount}})
                </button>
                <button type="button" data-filter="liquid" class="filter-btn px-3 py-1.5 text-sm font-medium bg-white dark:bg-surface-highlight text-gray-600 dark:text-gray-300 transition-colors border-l border-gray-300 dark:border-border-dark">
                    Liquid ({{.LiquidCount}})
                </button>
            </div>
            <div class="flex-1"></div>
            <div class="relative">
                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                <input type="text" id="search-ingredients" placeholder="Search ingredients..."
                       class="pl-10 pr-4 py-2 text-sm rounded-lg border border-gray-300 dark:border-border-dark bg-gray-50 dark:bg-surface-highlight text-gray-900 dark:text-white w-64 focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
        </div>
    </div>

    <!-- Ingredients Grid -->
    {{if .Ingredients}}
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3" id="ingredients-grid">
        {{range .Ingredients}}
        <div class="ingredient-card group relative bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-dark rounded-xl p-3 hover:border-primary-500/50 hover:shadow-lg transition-all duration-200"
             data-name="{{.Name}}" data-moisture="{{.MoistureType}}">
            <!-- Card Header -->
            <div class="flex items-center gap-2 mb-2">
                <span class="material-symbols-outlined text-lg
                    {{if eq .MoistureType "dry"}}text-yellow-600 dark:text-yellow-400
                    {{else if eq .MoistureType "wet"}}text-green-600 dark:text-green-400
                    {{else if eq .MoistureType "liquid"}}text-blue-600 dark:text-blue-400
                    {{else}}text-primary{{end}}">
                    {{if eq .MoistureType "dry"}}inventory{{else if eq .MoistureType "wet"}}grass{{else if eq .MoistureType "liquid"}}water_drop{{else}}inventory_2{{end}}
                </span>
                <span class="text-xs px-1.5 py-0.5 rounded font-medium
                    {{if eq .MoistureType "dry"}}bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400
                    {{else if eq .MoistureType "wet"}}bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400
                    {{else if eq .MoistureType "liquid"}}bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400
                    {{else}}bg-gray-100 dark:bg-surface-highlight text-gray-600 dark:text-gray-300{{end}}">
                    {{.MoistureType}}
                </span>
            </div>

            <!-- Name -->
            <h3 class="text-sm font-bold text-gray-900 dark:text-white truncate mb-2" title="{{.Name}}">{{.Name}}</h3>

            <!-- Status -->
            <div class="flex items-center gap-1 mb-2">
                {{if .IsActive}}
                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                <span class="text-xs text-green-600 dark:text-green-400">Active</span>
                {{else}}
                <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                <span class="text-xs text-gray-500">Inactive</span>
                {{end}}
            </div>

            <!-- Actions -->
            <div class="flex gap-1 pt-2 border-t border-gray-100 dark:border-border-dark">
                <button onclick="openEditModal('{{.ID}}')" class="flex-1 p-1.5 rounded-lg text-gray-400 dark:text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-gray-700 dark:hover:text-white transition-colors flex items-center justify-center" title="Edit">
                    <span class="material-symbols-outlined text-sm">edit</span>
                </button>
                <button onclick="confirmDelete('{{.ID}}', '{{.Name}}')" class="flex-1 p-1.5 rounded-lg text-gray-400 dark:text-gray-500 hover:bg-red-100 dark:hover:bg-red-900/30 hover:text-red-600 dark:hover:text-red-400 transition-colors flex items-center justify-center" title="Delete">
                    <span class="material-symbols-outlined text-sm">delete</span>
                </button>
            </div>
        </div>
        {{end}}
    </div>
    {{else}}
    <div class="flex flex-col items-center justify-center py-16 bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-dark rounded-xl">
        <div class="bg-gray-100 dark:bg-surface-highlight p-4 rounded-full mb-4">
            <span class="material-symbols-outlined text-4xl text-gray-400">inventory_2</span>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No ingredients found</h3>
        <p class="text-gray-500 dark:text-gray-400 mb-6">Get started by adding your first ingredient</p>
        <button onclick="openCreateModal()"
                class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover">
            <span class="material-symbols-outlined mr-2">add</span>
            Add Your First Ingredient
        </button>
    </div>
    {{end}}
</div>

<!-- Create/Edit Modal -->
<div id="ingredient-modal" class="fixed inset-0 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-black/50" onclick="closeModal()"></div>
        <div class="relative bg-white dark:bg-surface-dark rounded-xl shadow-xl w-full max-w-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-900 dark:text-white">Add Ingredient</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form id="ingredient-form" hx-post="/api/v1/ingredients" hx-swap="none">
                <input type="hidden" name="tenant_id" id="ingredient-tenant-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name</label>
                        <input type="text" name="name" required
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-border-dark bg-gray-50 dark:bg-surface-highlight text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"
                               placeholder="Flour">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Moisture Type</label>
                        <input type="hidden" name="moisture_type" id="moisture-type-input" value="dry" required>
                        <div class="flex rounded-lg border border-gray-300 dark:border-border-dark overflow-hidden">
                            <button type="button" data-value="dry" class="moisture-btn flex-1 px-3 py-2 text-sm font-medium bg-primary text-white transition-colors">
                                Dry
                            </button>
                            <button type="button" data-value="wet" class="moisture-btn flex-1 px-3 py-2 text-sm font-medium bg-white dark:bg-surface-highlight text-gray-600 dark:text-gray-300 transition-colors border-l border-gray-300 dark:border-border-dark">
                                Wet
                            </button>
                            <button type="button" data-value="liquid" class="moisture-btn flex-1 px-3 py-2 text-sm font-medium bg-white dark:bg-surface-highlight text-gray-600 dark:text-gray-300 transition-colors border-l border-gray-300 dark:border-border-dark">
                                Liquid
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Shelf Life (hours)</label>
                        <input type="number" name="shelf_life_hours" min="0"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-border-dark bg-gray-50 dark:bg-surface-highlight text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"
                               placeholder="24">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Allergen Info</label>
                        <input type="text" name="allergen_info"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-border-dark bg-gray-50 dark:bg-surface-highlight text-gray-900 dark:text-white focus:ring-2 focus:ring-primary"
                               placeholder="Gluten, Nuts (comma separated)">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="is_active" id="is-active" checked
                               class="w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary">
                        <label for="is-active" class="text-sm font-medium text-gray-700 dark:text-gray-300">Active</label>
                    </div>
                </div>
                <div class="flex items-center justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeModal()"
                            class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentMoistureFilter = '';

function filterIngredients() {
    const searchTerm = document.getElementById('search-ingredients').value.toLowerCase();

    document.querySelectorAll('.ingredient-card').forEach(card => {
        const name = (card.dataset.name || '').toLowerCase();
        const moisture = (card.dataset.moisture || '').toLowerCase();

        const matchesMoisture = !currentMoistureFilter || moisture === currentMoistureFilter;
        const matchesSearch = !searchTerm || name.includes(searchTerm);

        card.style.display = matchesMoisture && matchesSearch ? '' : 'none';
    });
}

document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        currentMoistureFilter = btn.dataset.filter;

        document.querySelectorAll('.filter-btn').forEach(b => {
            if (b === btn) {
                b.classList.remove('bg-white', 'dark:bg-surface-highlight', 'text-gray-600', 'dark:text-gray-300');
                b.classList.add('bg-primary', 'text-white', 'filter-active');
            } else {
                b.classList.remove('bg-primary', 'text-white', 'filter-active');
                b.classList.add('bg-white', 'dark:bg-surface-highlight', 'text-gray-600', 'dark:text-gray-300');
            }
        });

        filterIngredients();
    });
});

// Moisture type button handler
document.querySelectorAll('.moisture-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.getElementById('moisture-type-input').value = btn.dataset.value;

        document.querySelectorAll('.moisture-btn').forEach(b => {
            if (b === btn) {
                b.classList.remove('bg-white', 'dark:bg-surface-highlight', 'text-gray-600', 'dark:text-gray-300');
                b.classList.add('bg-primary', 'text-white');
            } else {
                b.classList.remove('bg-primary', 'text-white');
                b.classList.add('bg-white', 'dark:bg-surface-highlight', 'text-gray-600', 'dark:text-gray-300');
            }
        });
    });
});

function resetMoistureButtons(value = 'dry') {
    document.getElementById('moisture-type-input').value = value;
    document.querySelectorAll('.moisture-btn').forEach(btn => {
        if (btn.dataset.value === value) {
            btn.classList.remove('bg-white', 'dark:bg-surface-highlight', 'text-gray-600', 'dark:text-gray-300');
            btn.classList.add('bg-primary', 'text-white');
        } else {
            btn.classList.remove('bg-primary', 'text-white');
            btn.classList.add('bg-white', 'dark:bg-surface-highlight', 'text-gray-600', 'dark:text-gray-300');
        }
    });
}

function openCreateModal() {
    document.getElementById('modal-title').textContent = 'Add Ingredient';
    document.getElementById('ingredient-form').setAttribute('hx-post', '/api/v1/ingredients');
    document.getElementById('ingredient-form').reset();
    resetMoistureButtons('dry');
    document.getElementById('ingredient-modal').classList.remove('hidden');
    htmx.process(document.getElementById('ingredient-form'));
}

function openEditModal(id) {
    document.getElementById('modal-title').textContent = 'Edit Ingredient';
    document.getElementById('ingredient-form').setAttribute('hx-put', '/api/v1/ingredients/' + id);
    document.getElementById('ingredient-modal').classList.remove('hidden');
    htmx.process(document.getElementById('ingredient-form'));
}

function closeModal() {
    document.getElementById('ingredient-modal').classList.add('hidden');
}

function confirmDelete(id, name) {
    if (confirm('Are you sure you want to delete "' + name + '"?')) {
        htmx.ajax('DELETE', '/api/v1/ingredients/' + id, {
            target: '#ingredients-grid',
            swap: 'innerHTML'
        }).then(() => {
            window.location.reload();
        });
    }
}

document.getElementById('search-ingredients')?.addEventListener('input', filterIngredients);
</script>
{{end}}
